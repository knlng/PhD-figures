---
title: "qc-one-sample_cells-genes"
author: Linda Nguyen
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    theme: sandstone
  pdf_document:
    toc: true
    toc_depth: 5
    number_sections: true
    df_print: kable
params:
  chapter_name: "chapter4_scRNA-seq" # edit manually
knit: |
  (function(inputFile, encoding) {
    library(rmarkdown)
    yaml_params <- rmarkdown::yaml_front_matter(inputFile)$params
    
    # extract title from YAML front matter
    script_title <- rmarkdown::yaml_front_matter(inputFile)$title
    chapter_name <- yaml_params$chapter_name
    analysis_date <- format(Sys.Date(), "%Y-%m-%d")
    
    # output directory for knitted outputs
    output_dir <- file.path("../../scripts_HTML+PDF")
    if (!dir.exists(output_dir)) {
      dir.create(output_dir, recursive = TRUE)
    }
    
    # output formats and extensions
    formats <- c("html_document", "pdf_document")
    extensions <- c(".html", ".pdf")
    
    # render to each format
    for (i in seq_along(formats)) {
      output_file <- file.path(
        output_dir,
        paste0(script_title, "_", analysis_date, extensions[i])
      )
      rmarkdown::render(
        input = inputFile, 
        encoding = encoding,
        params = yaml_params,
        output_format = formats[i],
        output_file = output_file
      )
    }
  })
---

# Introduction

This script creates figures for the PhD chapter **`r params$chapter_nr`**.

This script:

* creates violin plots and summary statistics from one sample as an example


# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load utilities.

```{r load utilities, echo=TRUE, message=FALSE}
# load utilities
source("../utils/packages.R")
source("../utils/fonts.R")
source("../utils/setup.R")
source("../utils/theme_thesis.R")
source("../utils/colours.R")

# setup packages and fonts
load_thesis_packages()
setup_latex_fonts()

# setup paths for figures
# check manually that matches the title in YAML
script_title <- "qc-one-sample_cells-genes"
dir.out <- file.path("../../outputs", "chapter4_scRNA-seq", script_title)
if (!dir.exists(dir.out)) {
  dir.create(dir.out, recursive = TRUE)
}
setup_knitr_opts(dir.out)
```


# Data import

Select example sample.

```{r select example sample}
expt_name <- "atrd2_p13"
sample_name <- "1_WT_AS654"
```

Paths of SCE objects.

```{r paths of SCE objects}
dir.in <- paste0(
  "/home/ln/Documents/rna-seq_single-cell/",
  expt_name,
  "/outputs/03_qc_bioconductor/rds-files/"
)
```

Import SCE objects of interest.

```{r SCE objects of interest}
sce.raw.woED <- readRDS(paste0(dir.in, sample_name, "_sce.raw.woED.rds"))
sce.raw.woED

sce.cb.woED <- readRDS(paste0(dir.in, sample_name, "_sce.cb.woED.rds"))
sce.cb.woED

sce.qc <- readRDS(paste0(dir.in, sample_name, "_quality-controlled.rds"))
sce.qc
```


# Violin plots

## Violin plot sce.raw.woED

```{r violin_1-sce.raw.woED, fig.width=6, fig.height=2.5}
p1_raw <- plotColData(sce.raw.woED, y = "total") +
  ylab("Total number of\ncounts per cell") +
  scale_y_log10(limits = c(NA, 50000)) +
  theme_classic()

p2_raw <- plotColData(sce.raw.woED, y = "detected") +
  ylab("Total number of\ndetected genes per cell") +
  scale_y_log10(limits = c(NA, 10000)) +
  theme_classic()

# combine plots
p_raw <- plot_grid(
  p1_raw, p2_raw,
  align = "vh",
  ncol = 2
)

p_raw +
  plot_annotation(
    title = "Raw data",
    theme = theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  )
```


## Violin plot sce.cb.woED

```{r violin_2-sce.cb.woED, fig.width=6, fig.height=2.5}
p1_cb <- plotColData(sce.cb.woED, y = "total") +
  ylab("Total number of\ncounts per cell") +
  scale_y_log10(limits = c(NA, 50000)) +
  theme_classic()

p2_cb <- plotColData(sce.cb.woED, y = "detected") +
  ylab("Total number of\ndetected genes per cell") +
  scale_y_log10(limits = c(NA, 10000)) +
  theme_classic()

# combine plots
p_cb <- plot_grid(
  p1_cb, p2_cb,
  align = "vh",
  ncol = 2
)

p_cb +
  plot_annotation(
    title = "Ambient RNA corrected",
    theme = theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  )
```


## Violin plot sce.qc

```{r violin_3-sce.qc, fig.width=6, fig.height=2.5}
p1_qc <- plotColData(sce.qc, y = "total") +
  ylab("Total number of\ncounts per cell") +
  scale_y_log10() +
  theme_classic()

p2_qc <- plotColData(sce.qc, y = "detected") +
  ylab("Total number of\ndetected genes per cell") +
  scale_y_log10() +
  theme_classic()

# combine plots
p_qc <- plot_grid(
  p1_qc, p2_qc,
  align = "vh",
  ncol = 2
)

p_qc +
  plot_annotation(
    title = "Quality-filtered",
    theme = theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  )
```


## Combined violin plots

```{r violins_cells-genes_example, fig.width=6, fig.height=8}
# create row 1 with label and title
title_raw <- ggdraw() + 
  draw_label("A", fontface = "bold", size = 14, x = 0, hjust = 0) +
  draw_label("Raw data", fontface = "bold", size = 12)
row1 <- plot_grid(p1_raw, p2_raw, ncol = 2, align = "h")
row1_titled <- plot_grid(title_raw, row1, ncol = 1, rel_heights = c(0.1, 1))

# create row 2 with label and title
title_cb <- ggdraw() + 
  draw_label("B", fontface = "bold", size = 14, x = 0, hjust = 0) +
  draw_label("Ambient RNA corrected", fontface = "bold", size = 12)
row2 <- plot_grid(p1_cb, p2_cb, ncol = 2, align = "h")
row2_titled <- plot_grid(title_cb, row2, ncol = 1, rel_heights = c(0.1, 1))

# create row 3 with label and title
title_qc <- ggdraw() + 
  draw_label("C", fontface = "bold", size = 14, x = 0, hjust = 0) +
  draw_label("Quality-filtered", fontface = "bold", size = 12)
row3 <- plot_grid(p1_qc, p2_qc, ncol = 2, align = "h")
row3_titled <- plot_grid(title_qc, row3, ncol = 1, rel_heights = c(0.1, 1))

# combine all rows
combined_plot <- plot_grid(
  row1_titled,
  row2_titled,
  row3_titled,
  ncol = 1,
  align = "v"
) +
  theme(plot.margin = margin(5, 5, 5, 5))
combined_plot
```


# Summary statistics

## Extract data from sce.qc

```{r extract data from sce.qc}
# extract qc_summary from metadata
qc_summary <- metadata(sce.qc)$qc_summary
sample_name <- qc_summary$sample_name

# create qc summary data frame
qc_labels <- c(
  "raw",
  "w/o background",
  "w/o NA values",
  "w/o empty droplets",
  "cell filter",
  "doublet status",
  "protein-coding",
  "final QC"
)

qc_summary_df <- data.frame(
  Step = qc_labels,
  Num_Cells = as.numeric(unlist(qc_summary[c(
    "num_cells_raw",
    "num_cells_cellbender",
    "num_cells_after_NA",
    "num_cells_after_ED",
    "num_cells_after_CF",
    "num_cells_after_Dbl",
    "num_cells_after_PCG",
    "num_cells_after_QC"
  )])),
  Num_Genes = as.numeric(unlist(qc_summary[c(
    "num_genes_raw",
    "num_genes_cellbender",
    "num_genes_after_NA",
    "num_genes_after_ED",
    "num_genes_after_CF",
    "num_genes_after_Dbl",
    "num_genes_after_PCG",
    "num_genes_after_QC"
  )]))
)

# reshape data for plotting counts
qc_plot_counts <- qc_summary_df %>%
  select(Step, Num_Cells, Num_Genes) %>%
  pivot_longer(
    cols = starts_with("Num"),
    names_to = "Type",
    values_to = "Count"
  )

# rename 'Type' values for clarity
qc_plot_counts$Type <- recode(
  qc_plot_counts$Type,
  Num_Cells = "Cells",
  Num_Genes = "Genes"
)

# set 'Step' as a factor with levels in the desired order
qc_plot_counts$Step <- factor(qc_plot_counts$Step, levels = qc_labels)
```


# Summary statistics

## Counts

```{r summary-statistics_numbers, fig.width=6, fig.height=4}
# create counts plot with log scale
p_qc_numbers <- ggplot(
  qc_plot_counts, 
  aes(x = Step, y = Count, group = Type, color = Type)
) +
  geom_line(alpha = 0.3) +
  geom_point(size = 3) +
  geom_text(
    aes(label = scales::comma(Count)),
    vjust = -1, 
    size = 3,
    show.legend = FALSE
  ) +
  scale_y_log10() +
  coord_cartesian(clip = "off") +
  theme_thesis_simple() +
  scale_x_discrete(position = "top") +
  labs(
    title = paste("Number of cells and genes retained at each QC step"),
    x = "",
    y = "Count"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 0, vjust = 0),
    legend.title = element_blank(),
    legend.position = "right",
    panel.grid.major.x = element_line(color = "grey90", linewidth = 0.5)
  )

p_qc_numbers
```


## Percentages

```{r summary-statistics_percentages, fig.width=6, fig.height=4}
# create percentage plot
p_qc_percent <- ggplot(
  qc_plot_percent, 
  aes(x = Step, y = Percentage, group = Type, color = Type)
) +
  geom_line(alpha = 0.3) +
  geom_point(size = 3) +
  ggrepel::geom_text_repel(
    aes(label = sprintf("%.2f%%", Percentage)),
    size = 3,
    show.legend = FALSE,
    direction = "y",
    min.segment.length = 0,
    box.padding = 0.4
  ) +
  ylim(0, 119) +
  coord_cartesian(clip = "off") +
  theme_thesis_simple() +
  scale_x_discrete(position = "top") +
  labs(
    title = paste("Percentage of cells and genes retained at each QC step"),
    x = "",
    y = "Percentage (%)"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 0, vjust = 0),
    legend.title = element_blank(),
    legend.position = "right",
    panel.grid.major.x = element_line(color = "grey90", linewidth = 0.5)
  )

p_qc_percent
```


## Combined summary statistics

```{r summary-statistics_combined, fig.width=6, fig.height=8}
combined_summary_plot <- plot_grid(
  p_qc_numbers,
  NULL, # add space between plots
  p_qc_percent,
  labels = c("A", "", "B"),
  label_size = 14,
  label_fontface = "bold",
  ncol = 1,
  align = "v",
  rel_heights = c(1, 0.1, 1) # add space between plots
)

print(combined_summary_plot)
```


# Session info

```{r session info}
sessionInfo()
```
